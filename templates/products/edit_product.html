{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Product - CrazyCart{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Edit Product</h1>
                <p class="text-gray-600 mt-2">Update your product listing: {{ product.name }}</p>
            </div>
            <div class="flex space-x-4">
                <a href="{% url 'products:product_detail' product.slug %}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200">
                    View Product
                </a>
                <a href="{% url 'products:seller_products' %}" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200">
                    Back to Products
                </a>
            </div>
        </div>
    </div>

    <!-- Edit Product Form -->
    <div class="bg-white rounded-lg shadow-md">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900">Product Details</h2>
        </div>
        
        <form method="post" enctype="multipart/form-data" class="p-6">
            {% csrf_token %}
            
            <!-- Basic Information -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Product Name -->
                    <div class="md:col-span-2">
                        <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Product Name *
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.name.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Category -->
                    <div>
                        <label for="{{ form.category.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Category *
                        </label>
                        {{ form.category }}
                        {% if form.category.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.category.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Condition -->
                    <div>
                        <label for="{{ form.condition.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Condition *
                        </label>
                        {{ form.condition }}
                        {% if form.condition.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.condition.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Description -->
                    <div class="md:col-span-2">
                        <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Description *
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.description.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Add New Product Images -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Add New Images
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-gray-400 transition-colors">
                            <div class="text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="mt-4">
                                    <label for="product-images-edit" class="cursor-pointer">
                                        <span class="mt-2 block text-sm font-medium text-gray-900">
                                            Upload additional images
                                        </span>
                                        <span class="mt-1 block text-sm text-gray-500">
                                            PNG, JPG, GIF up to 10MB each (Maximum 5 images)
                                        </span>
                                    </label>
                                    <input id="product-images-edit" name="images" type="file" class="sr-only" multiple accept="image/*" onchange="handleImagePreview(this)">
                                </div>
                                <p class="text-xs text-gray-500 mt-2">
                                    These will be added to your existing images
                                </p>
                            </div>
                        </div>
                        
                        <!-- Image Preview Container -->
                        <div id="image-preview-container" class="mt-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 hidden">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pricing -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Pricing</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Current Price -->
                    <div>
                        <label for="{{ form.price.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Current Price (৳) *
                        </label>
                        {{ form.price }}
                        {% if form.price.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.price.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Original Price -->
                    <div>
                        <label for="{{ form.original_price.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Original Price (৳)
                        </label>
                        {{ form.original_price }}
                        <p class="mt-1 text-xs text-gray-500">Optional: Show discount from original price</p>
                        {% if form.original_price.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.original_price.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Stock Quantity -->
                    <div>
                        <label for="{{ form.stock_quantity.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Stock Quantity *
                        </label>
                        {{ form.stock_quantity }}
                        {% if form.stock_quantity.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.stock_quantity.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Product Specifications -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Product Specifications</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Brand -->
                    <div>
                        <label for="{{ form.brand.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Brand
                        </label>
                        {{ form.brand }}
                        {% if form.brand.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.brand.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Model -->
                    <div>
                        <label for="{{ form.model.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Model
                        </label>
                        {{ form.model }}
                        {% if form.model.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.model.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Color -->
                    <div>
                        <label for="{{ form.color.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Color
                        </label>
                        {{ form.color }}
                        {% if form.color.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.color.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Size -->
                    <div>
                        <label for="{{ form.size.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Size
                        </label>
                        {{ form.size }}
                        {% if form.size.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.size.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Weight -->
                    <div>
                        <label for="{{ form.weight.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Weight (kg)
                        </label>
                        {{ form.weight }}
                        {% if form.weight.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.weight.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Dimensions -->
                    <div>
                        <label for="{{ form.dimensions.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Dimensions
                        </label>
                        {{ form.dimensions }}
                        <p class="mt-1 text-xs text-gray-500">e.g., 10cm x 5cm x 2cm</p>
                        {% if form.dimensions.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.dimensions.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Bargaining Settings -->
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Bargaining Settings</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Allow Bargaining -->
                    <div class="md:col-span-2">
                        <div class="flex items-center">
                            {{ form.allow_bargaining }}
                            <label for="{{ form.allow_bargaining.id_for_label }}" class="text-sm font-medium text-gray-700">
                                Allow buyers to negotiate the price
                            </label>
                        </div>
                        <p class="mt-1 text-xs text-gray-500">Enable this to let buyers make price offers</p>
                        {% if form.allow_bargaining.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.allow_bargaining.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Minimum Bargain Price -->
                    <div>
                        <label for="{{ form.minimum_bargain_price.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Minimum Bargain Price (৳)
                        </label>
                        {{ form.minimum_bargain_price }}
                        <p class="mt-1 text-xs text-gray-500">Lowest price you'll accept</p>
                        {% if form.minimum_bargain_price.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.minimum_bargain_price.errors.0 }}</p>
                        {% endif %}
                    </div>
                    
                    <!-- Is Featured -->
                    <div class="flex items-center">
                        {{ form.is_featured }}
                        <label for="{{ form.is_featured.id_for_label }}" class="text-sm font-medium text-gray-700">
                            Feature this product
                        </label>
                        <p class="ml-2 text-xs text-gray-500">(Additional fees may apply)</p>
                        {% if form.is_featured.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.is_featured.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Current Product Images (if any) -->
            {% if product.images.all %}
            <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Current Images</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {% for image in product.images.all %}
                        <div class="relative group">
                            <img src="{{ image.image.url }}" alt="{{ product.name }}" class="w-full h-32 object-cover rounded-lg">
                            <div class="absolute top-2 left-2">
                                {% if image.is_primary %}
                                    <span class="bg-blue-600 text-white text-xs px-2 py-1 rounded">
                                        Main
                                    </span>
                                {% else %}
                                    <span class="bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">
                                        Image {{ forloop.counter }}
                                    </span>
                                {% endif %}
                            </div>
                            <button type="button" onclick="deleteProductImage({{ image.id }})" class="absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    {% endfor %}
                </div>
                <p class="mt-2 text-sm text-gray-500">
                    Hover over images to delete them. Upload new images using the form above.
                </p>
            </div>
            {% endif %}

            <!-- Form Actions -->
            <div class="flex justify-between items-center pt-6 border-t border-gray-200">
                <div class="flex space-x-4">
                    <a href="{% url 'products:seller_products' %}" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition duration-200">
                        Cancel
                    </a>
                    <a href="{% url 'products:product_detail' product.slug %}" class="border border-gray-300 hover:bg-gray-50 text-gray-700 px-6 py-3 rounded-lg font-medium transition duration-200">
                        Preview
                    </a>
                </div>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition duration-200">
                    Update Product
                </button>
            </div>
        </form>
    </div>

    <!-- Product Stats -->
    <div class="mt-8 bg-blue-50 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-blue-900 mb-4">📊 Product Performance</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-blue-800">
            <div class="flex items-center justify-between">
                <span>Product Views:</span>
                <span class="font-semibold">{{ product.view_count|default:"0" }}</span>
            </div>
            <div class="flex items-center justify-between">
                <span>Times Added to Cart:</span>
                <span class="font-semibold">0</span>
            </div>
            <div class="flex items-center justify-between">
                <span>Times Purchased:</span>
                <span class="font-semibold">{{ product.purchase_count|default:"0" }}</span>
            </div>
        </div>
        
        <div class="mt-4 pt-4 border-t border-blue-200">
            <h4 class="font-semibold text-blue-900 mb-2">💡 Optimization Tips</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-blue-800">
                <div class="flex items-start">
                    <svg class="w-4 h-4 mr-2 mt-0.5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Use high-quality, clear product images</span>
                </div>
                <div class="flex items-start">
                    <svg class="w-4 h-4 mr-2 mt-0.5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Add multiple images from different angles</span>
                </div>
                <div class="flex items-start">
                    <svg class="w-4 h-4 mr-2 mt-0.5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Keep stock levels updated</span>
                </div>
                <div class="flex items-start">
                    <svg class="w-4 h-4 mr-2 mt-0.5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Respond quickly to bargain requests</span>
                </div>
                <div class="flex items-start">
                    <svg class="w-4 h-4 mr-2 mt-0.5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Use competitive pricing strategies</span>
                </div>
                <div class="flex items-start">
                    <svg class="w-4 h-4 mr-2 mt-0.5 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Remove outdated or poor quality images</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function handleImagePreview(input) {
    const previewContainer = document.getElementById('image-preview-container');
    const files = input.files;
    
    // Clear previous previews
    previewContainer.innerHTML = '';
    
    if (files.length > 0) {
        previewContainer.classList.remove('hidden');
        
        // Limit to 5 images
        const maxFiles = Math.min(files.length, 5);
        
        for (let i = 0; i < maxFiles; i++) {
            const file = files[i];
            
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'relative group';
                    
                    previewDiv.innerHTML = `
                        <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden">
                            <img src="${e.target.result}" alt="Preview" class="w-full h-full object-cover">
                        </div>
                        <span class="absolute top-1 left-1 bg-green-600 text-white text-xs px-2 py-1 rounded">New</span>
                        <button type="button" onclick="removeNewImage(this, ${i})" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    `;
                    
                    previewContainer.appendChild(previewDiv);
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        if (files.length > 5) {
            alert('Only the first 5 images will be uploaded.');
        }
    } else {
        previewContainer.classList.add('hidden');
    }
}

function removeNewImage(button, index) {
    const input = document.getElementById('product-images-edit');
    const dt = new DataTransfer();
    
    // Add all files except the one to remove
    for (let i = 0; i < input.files.length; i++) {
        if (i !== index) {
            dt.items.add(input.files[i]);
        }
    }
    
    input.files = dt.files;
    handleImagePreview(input);
}

function deleteProductImage(imageId) {
    if (confirm('Are you sure you want to delete this image? This action cannot be undone.')) {
        fetch('{% url "products:delete_product_image" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                'image_id': imageId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Reload page to show updated images
            } else {
                alert('Error deleting image: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting image.');
        });
    }
}
</script>

{% endblock %}
