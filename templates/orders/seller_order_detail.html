{% extends 'base.html' %}
{% load static %}

{% block title %}Order #{{ order.order_number }} - Seller View - CrazyCart{% endblock %}

{% block content %}
{% csrf_token %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Order #{{ order.order_number }}</h1>
                <p class="text-gray-600 mt-2">Seller view - Your items in this order</p>
            </div>
            <div class="flex space-x-4">
                <a href="{% url 'orders:seller_orders' %}" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200">
                    Back to Orders
                </a>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Order Information -->
        <div class="lg:col-span-2">
            <!-- Your Items in this Order -->
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900">Your Items in this Order</h2>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        {% for item in seller_items %}
                            <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg">
                                {% if item.product.images.first %}
                                    <img src="{{ item.product.images.first.image.url }}" alt="{{ item.product.name }}" class="w-16 h-16 rounded-lg object-cover">
                                {% else %}
                                    <div class="w-16 h-16 bg-gray-300 rounded-lg flex items-center justify-center">
                                        <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                    </div>
                                {% endif %}
                                <div class="flex-1">
                                    <h3 class="font-medium text-gray-900">{{ item.product.name }}</h3>
                                    <p class="text-sm text-gray-600">Quantity: {{ item.quantity }}</p>
                                    <p class="text-sm text-gray-600">Price: ৳{{ item.price_at_time }} each</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-gray-900">৳{{ item.total_price }}</p>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                        {% if item.status == 'pending' %}bg-yellow-100 text-yellow-800
                                        {% elif item.status == 'confirmed' %}bg-blue-100 text-blue-800
                                        {% elif item.status == 'processing' %}bg-purple-100 text-purple-800
                                        {% elif item.status == 'shipped' %}bg-indigo-100 text-indigo-800
                                        {% elif item.status == 'delivered' %}bg-green-100 text-green-800
                                        {% elif item.status == 'cancelled' %}bg-red-100 text-red-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ item.get_status_display }}
                                    </span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Order Actions -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900">Order Actions</h2>
                    <p class="text-sm text-gray-600 mt-1">Manage the status of this order</p>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        {% if order.status == 'pending' or order.status == 'confirmed' %}
                            <div class="flex items-center justify-between p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <div>
                                    <h3 class="font-medium text-yellow-800">Ready to Process</h3>
                                    <p class="text-sm text-yellow-600">Mark this order as being processed</p>
                                </div>
                                <button onclick="updateOrderStatus('{{ order.order_number }}', 'processing')" 
                                        class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-lg font-medium transition duration-200 flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Mark as Processing
                                </button>
                            </div>
                        {% elif order.status == 'processing' %}
                            <div class="flex items-center justify-between p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <div>
                                    <h3 class="font-medium text-blue-800">Ready to Ship</h3>
                                    <p class="text-sm text-blue-600">Mark this order as shipped</p>
                                </div>
                                <div class="flex space-x-3">
                                    <input type="text" placeholder="Tracking Number (Optional)" id="trackingNumber" 
                                           class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                    <button onclick="updateOrderStatusWithTracking('{{ order.order_number }}', 'shipped')" 
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition duration-200 flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8l6 6 10-10"></path>
                                        </svg>
                                        Mark as Shipped
                                    </button>
                                </div>
                            </div>
                        {% elif order.status == 'shipped' %}
                            <div class="flex items-center justify-between p-4 bg-green-50 border border-green-200 rounded-lg">
                                <div>
                                    <h3 class="font-medium text-green-800">Ready to Deliver</h3>
                                    <p class="text-sm text-green-600">Mark this order as delivered</p>
                                </div>
                                <button onclick="updateOrderStatus('{{ order.order_number }}', 'delivered')" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition duration-200 flex items-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    Mark as Delivered
                                </button>
                            </div>
                        {% elif order.status == 'delivered' %}
                            <div class="p-4 bg-green-50 border border-green-200 rounded-lg text-center">
                                <div class="flex items-center justify-center mb-2">
                                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="font-medium text-green-800">Order Completed</h3>
                                <p class="text-sm text-green-600">This order has been successfully delivered</p>
                            </div>
                        {% elif order.status == 'cancelled' %}
                            <div class="p-4 bg-red-50 border border-red-200 rounded-lg text-center">
                                <div class="flex items-center justify-center mb-2">
                                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="font-medium text-red-800">Order Cancelled</h3>
                                <p class="text-sm text-red-600">This order has been cancelled</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="lg:col-span-1">
            <!-- Order Details -->
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900">Order Details</h2>
                </div>
                <div class="p-6">
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Order Number:</span>
                            <span class="font-medium">{{ order.order_number }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Order Date:</span>
                            <span class="font-medium">{{ order.created_at|date:"M d, Y" }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Customer:</span>
                            <span class="font-medium">{{ order.user.get_full_name|default:order.user.username }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Order Status:</span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                {% if order.status == 'pending' %}bg-yellow-100 text-yellow-800
                                {% elif order.status == 'confirmed' %}bg-blue-100 text-blue-800
                                {% elif order.status == 'processing' %}bg-purple-100 text-purple-800
                                {% elif order.status == 'shipped' %}bg-indigo-100 text-indigo-800
                                {% elif order.status == 'delivered' %}bg-green-100 text-green-800
                                {% elif order.status == 'cancelled' %}bg-red-100 text-red-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ order.get_status_display }}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total Order Value:</span>
                            <span class="font-bold text-green-600">৳{{ order.total_amount }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Your Items Value:</span>
                            <span class="font-bold text-blue-600">৳{{ seller_total }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shipping Information -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900">Shipping Address</h2>
                </div>
                <div class="p-6">
                    <div class="space-y-2 text-sm">
                        <p class="font-medium">{{ order.shipping_name }}</p>
                        <p class="text-gray-600">{{ order.shipping_address }}</p>
                        <p class="text-gray-600">{{ order.shipping_city }}, {{ order.shipping_state }} {{ order.shipping_postal_code }}</p>
                        <p class="text-gray-600">{{ order.shipping_country }}</p>
                        <p class="text-gray-600">Phone: {{ order.shipping_phone }}</p>
                        <p class="text-gray-600">Email: {{ order.shipping_email }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updateOrderStatus(orderNumber, status) {
    showConfirmDialog(`Are you sure you want to mark this order as ${status}?`, () => {
        const formData = new FormData();
        formData.append('status', status);
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.querySelector('[name=csrf-token]')?.content ||
                         getCookie('csrftoken');
        
        fetch(`/orders/seller/orders/${orderNumber}/update/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showAlert(data.message || 'Order status updated successfully', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showAlert(data.message || 'Failed to update order status', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Failed to update order status', 'error');
        });
    });
}

function updateOrderStatusWithTracking(orderNumber, status) {
    const trackingNumber = document.getElementById('trackingNumber').value.trim();
    const message = trackingNumber ? 
        `Are you sure you want to mark this order as ${status} with tracking number: ${trackingNumber}?` :
        `Are you sure you want to mark this order as ${status}?`;
    
    showConfirmDialog(message, () => {
        const formData = new FormData();
        formData.append('status', status);
        if (trackingNumber) {
            formData.append('tracking_number', trackingNumber);
        }
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.querySelector('[name=csrf-token]')?.content ||
                         getCookie('csrftoken');
        
        fetch(`/orders/seller/orders/${orderNumber}/update/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showAlert(data.message || 'Order status updated successfully', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showAlert(data.message || 'Failed to update order status', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Failed to update order status', 'error');
        });
    });
}

// Utility function to get cookie value
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Simple fallback alert functions if ui.js functions are not available
if (typeof showAlert === 'undefined') {
    function showAlert(message, type) {
        alert(message);
    }
}

if (typeof showConfirmDialog === 'undefined') {
    function showConfirmDialog(message, callback) {
        if (confirm(message)) {
            callback();
        }
    }
}
</script>
{% endblock %}
